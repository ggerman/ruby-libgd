name: CI (Docker)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  docker-test:
    name: Build Docker image and run tests (Dockerfile detection)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find Dockerfile
        id: find-dockerfile
        run: |
          dockerfile=$(git ls-files Dockerfile | head -n1)
          if [ -z "$dockerfile" ]; then
            dockerfile=$(git ls-files **/Dockerfile | head -n1)
          fi
          if [ -z "$dockerfile" ]; then
            echo "No Dockerfile found in repository. Please add a Dockerfile at the repo root or specify its path." >&2
            exit 1
          fi
          echo "Found Dockerfile: $dockerfile"
          echo "::set-output name=path::$dockerfile"

      - name: Show Dockerfile and repo tree (for debugging)
        if: always()
        run: |
          echo "Dockerfile path: ${{ steps.find-dockerfile.outputs.path }}"
          echo "---- cat Dockerfile ----"
          sed -n '1,200p' "${{ steps.find-dockerfile.outputs.path }}" || true
          echo "---- repo root tree (top) ----"
          ls -la | sed -n '1,200p' || true

      - name: Build Docker image (using detected Dockerfile)
        run: |
          df="${{ steps.find-dockerfile.outputs.path }}"
          echo "Building docker image using -f $df with context ."
          docker build -f "$df" -t ruby-libgd-ci:latest .

      - name: Run compile, build, install and tests inside container
        run: |
          docker run --rm ruby-libgd-ci:latest bash -lc "
            set -e
            cd /app || cd /

            echo '--- compile native extension (ext/gd) ---'
            if [ -d ext/gd ]; then
              cd ext/gd
              make clean || true
              ruby extconf.rb
              make
              cd ../..
            else
              echo 'ext/gd not found; skipping native build step'
            fi

            echo '--- build and install gem from local source ---'
            if [ -f ruby-libgd.gemspec ]; then
              gem build ruby-libgd.gemspec
              gem_file=\$(ls ruby-libgd-*.gem 2>/dev/null | sort -V | tail -n 1 || true)
              if [ -n \"\$gem_file\" ]; then
                gem install \"\$gem_file\" --force
              else
                echo 'Built gem not found' && exit 1
              fi
            else
              echo 'ruby-libgd.gemspec not found; cannot build gem' && exit 1
            fi

            echo '--- install test/dev gems globally ---'
            gem install rspec chunky_png rake --no-document

            echo '--- run specs against the installed gem ---'
            if [ -d spec ]; then
              # use `ruby -S` so ruby locates the rspec executable even if gem bin dir isn't in PATH
              ruby -S rspec --format documentation
            else
              echo 'No spec directory found. Add specs under spec/ or update workflow.' && exit 78
            fi
          "