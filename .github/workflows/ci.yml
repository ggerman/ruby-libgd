name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Test on ${{ matrix.os }} / Ruby ${{ matrix.ruby-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        ruby-version: ['3.3', '3.4', '3.5']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}
          cache: bundler

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libgd-dev libpng-dev libjpeg-dev zlib1g-dev libfreetype6-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install pkg-config gd

      - name: Install bundler and (optional) project gems
        run: |
          gem install bundler
          bundle config set --local deployment 'false'
          if [ -f Gemfile ]; then
            # We still run bundle install to make bundler-managed gems available if needed,
            # but final test invocation will use the globally-installed gems below so the installed gem is exercised.
            bundle install --jobs 4 --retry 3 || true
          else
            echo "Gemfile not found; continuing."
          fi

      - name: Compile native extension (ext/gd)
        run: |
          set -e
          if [ -d "ext/gd" ]; then
            cd ext/gd
            make clean || true
            # If extconf.rb accepts custom flags, you can pass them here, e.g.:
            # ruby extconf.rb --with-gdlib=/usr/local
            ruby extconf.rb
            make
            cd ../..
          else
            echo "ext/gd not found; skipping native build step"
          fi

      - name: Build and install gem (always from local source)
        run: |
          set -e
          if [ -f "ruby-libgd.gemspec" ]; then
            gem build ruby-libgd.gemspec
            gem_file=$(ls ruby-libgd-*.gem 2>/dev/null | sort -V | tail -n 1 || true)
            if [ -n "$gem_file" ]; then
              gem install "$gem_file" --force
            else
              echo "Built gem not found; failing"
              exit 1
            fi
          else
            echo "ruby-libgd.gemspec not found; cannot build gem"
            exit 1
          fi

      - name: Install test/dev gems (global) and run specs against installed gem
        run: |
          set -e
          # Install the test tools globally so they run against the installed gem
          gem install rspec chunky_png rake --no-document
          # Run specs (not using `bundle exec`) so the installed gem is exercised
          if [ -d spec ]; then
            rspec --format documentation
          else
            echo "No spec directory found. Add specs under spec/ or update workflow."
            exit 78
          fi