name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Test on ${{ matrix.os }} / Ruby ${{ matrix.ruby-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        # Test Ruby 3.3 and higher â€” adjust this list to add future versions you want to test
        ruby-version: ['3.3', '3.4', '3.5']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}
          cache: bundler

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libgd-dev libpng-dev libjpeg-dev zlib1g-dev libfreetype6-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install pkg-config gd

      - name: Install bundler and project gems
        run: |
          gem install bundler
          bundle config set --local deployment 'false'
          if [ -f Gemfile ]; then
            bundle install --jobs 4 --retry 3
          else
            echo "Gemfile not found; CI expects you to upload a Gemfile so dev/test gems like rspec are installed."
          fi

      - name: Compile native extension (ext/gd)
        run: |
          set -e
          if [ -d "ext/gd" ]; then
            cd ext/gd
            make clean || true
            ruby extconf.rb
            make
            cd ../..
          else
            echo "ext/gd not found; skipping native build step"
          fi

      - name: Build and install gem (skipped if Gemfile points to local path)
        run: |
          set -e
          if [ -f Gemfile ] && grep -q 'gem *"ruby-libgd"[[:space:]]*,[[:space:]]*path:' Gemfile 2>/dev/null; then
            echo "Gemfile uses local path for ruby-libgd; skipping gem build/install"
          else
            if [ -f "ruby-libgd.gemspec" ]; then
              gem build ruby-libgd.gemspec
              gem_file=$(ls ruby-libgd-*.gem 2>/dev/null | sort -V | tail -n 1 || true)
              if [ -n "$gem_file" ]; then
                gem install "$gem_file" --force
              else
                echo "Built gem not found; continuing"
              fi
            else
              echo "ruby-libgd.gemspec not found; skipping gem build/install"
            fi
          fi

      - name: Run specs
        run: |
          if [ -d spec ]; then
            bundle exec rspec --format documentation
          else
            echo "No spec directory found. Add specs under spec/ or update the workflow test command."
            exit 78
          fi